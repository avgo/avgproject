<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AVG Project</title>
    <link rel="stylesheet" type="text/css" href="%SITE_DOC_DIR%toolkit.css"/>
    <style>
    .task {
      border: 1px solid;
      padding: 10px 10px 10px 30px;
      color: #FFFFFF;
      width: 200px;
    }
    .task_field {
      width: 200px;
      height: 40px;
    }
    .task_p {
      background-color: #6666FF;
    }
    .task_t {
      background-color: #9aa9fc;
    }
    .task_btn {
      color: #FFFFFF;
      font-family: Verdana;
    }
    .task_btn_p {
      font-size: 16pt;
      font-weight: bold;
    }
    .task_btn_t {
      font-size: 11pt;
      font-weight: bold;
    }
    .task_btn_s {
      font-size: 8pt;
    }
    .task_btn:hover {
      color: #66FFFF;
    }
    </style>
    <script src="%SITE_DOC_DIR%toolkit.js"></script>
    <script src="%SITE_DOC_DIR%tree_items.js"></script>
    <script>
    <!--
      var app = {
        cmp: function(a,b)
        {
          return a.priority < b.priority;
        },
      };

      function dtm_fmt_def(d)
      {
        return (
          pad(d.getDate()) + "." +
          pad(d.getMonth()+1) + "." +
          pad(d.getFullYear()) + ", " +
          pad(d.getHours()) + ":" +
          pad(d.getMinutes()) + ":" +
          pad(d.getSeconds())
        );
      }

      function get_tasks()
      {
        post_request().set(
          [
            [ "action", 1 ],
          ],
          function (r)
          {
            var tasks_nodes;

            eval("tasks_nodes = [\n" + r.responseText + "\n];");

            app.tasks = tree_store_build_tree(tasks_nodes, 50, app.cmp);

            /*
              Вообще, функция "tree_store_build_tree"  всегда  завершается  успешно,  за
              исключением случаев когда остаются элементы для которых parent_node  найти
              не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
              время.
            */

            var main = document.getElementById("main");

            tree_store_html_gen(main, app.tasks);
          }
        );
      }

      function on_load()
      {
        get_tasks(app);
      }

      function post_request(url, arr1)
      {
        if (!url)
          url = "";

        var query1 = ""; var amp1 = 0;

        function append(arr)
        {
          return arr[0] + "=" + encodeURIComponent(arr[1]);
        }

        if (arr1)
        {
          for (var i = 0; i < arr1.length; ++i)
          {
            if (amp1)
              query1 += "&";
            else
              amp1 = 1;
            query1 += append(arr1[i]);
          }
        }

        return {
          set: function(arr2, success)
          {
            var query2 = query1; var amp2 = amp1;

            for (var i = 0; i < arr2.length; ++i)
            {
              if (amp2)
                query2 += "&";
              else
                amp2 = 1;
              query2 += append(arr2[i]);
            }
            var r = new XMLHttpRequest();
            r.onreadystatechange = function ()
            {
              switch (r.readyState)
              {
              case 4:
                if (r.status == 200)
                  success(r);
                else
                  alert("request error.");
                break;
              }
            }
            r.open("POST", url, true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.send(query2);
          },
        };
      }

      function projects_tree_view_item_new_subt_click(parent_node)
      {
        var new_node = {
          parent_id: parent_node.id,
        };

        if (app.tasks == parent_node)
        {
          new_node.title        = "Проект";
          new_node.description  = "Описание проекта.";
          new_node.type         = node_type.project;
          new_node.offset       = 0;
        }
        else
        {
          new_node.title        = "задача";
          new_node.description  = "Описание задачи.";
          new_node.type         = node_type.task;
          new_node.offset       = parent_node.offset + app.tasks.offset_step;
        }

        new_node.priority = "";

        post_request().set(
          [
            [ "action",       "2"                  ],
            [ "parent_id",    new_node.parent_id   ],
            [ "title",        new_node.title       ],
            [ "description",  new_node.description ],
            [ "type",         new_node.type        ],
          ],
          function (r)
          {
            var resp;

            var cmd = "resp = " + r.responseText + ";";

            eval(cmd);

            if (!resp.id) // Произошла ошибка во время добавления на сервере
              return;

            new_node.id           = resp.id;
            new_node.dtm_created  = resp.dtm_created;

            tree_store_add(app.tasks, parent_node, new_node, app.cmp);

            projects_tree_view_update(new_node);
          }
        );
      }

      function projects_tree_view_update(node)
      {
        var is_new;

        var table = document.getElementById("table_item_" + node.id);

        if (table)
        {
          is_new = false;
          while (table.firstChild)
            table.removeChild(table.firstChild);
        }
        else
        {
          is_new = true;
          table = document.createElement("table");
          table.id = "table_item_" + node.id;
        }

        table.innerHTML = gen_html_for_node(node);

        if (is_new)
        {
          var bottom_node = tree_store_get_bottom_node(node);

          var table_bottom = document.getElementById("table_item_" + bottom_node.id);

          table_bottom.parentNode.insertBefore(table, table_bottom);
        }
      }

      var avgproject =
      {
        left_right: function(cmp)
        {
          var table = document.createElement("table");

          table.setAttribute("border", "0");

          var tr = document.createElement("tr");

          var td_tvt = document.createElement("td");

          td_tvt.style.setProperty("vertical-align", "top");
          td_tvt.style.setProperty("width", "32%");

          tr.appendChild(td_tvt);

          var td = document.createElement("td");

          td.setAttribute("id", "task");

          td.style.setProperty("vertical-align", "top");

          tr.appendChild(td);

          table.appendChild(tr);

          avgproject.tree_view_tasks(td_tvt, td, 50, cmp);

          return table;
        },
        tree_view_tasks: function(container, task_ws, offset_step, cmp)
        {
          function append_nodes(tree_node)
          {
            for ( var i = tree_node.first; i; i = i.next)
            {
              if (i.parent.id == 0)
                i.offset = 0;
              else
                i.offset = tree_node.offset + offset_step;

              container.appendChild(new_tv_node(i));

              if (i.first)
                append_nodes(i);
            }
          }

          function new_tv_node(tree_node)
          {
            var s;
            var title;

            if (tree_node.id == 0)
            {
              s = "p";
              title = "+[ADD]";
            }
            else
            {
              switch (tree_node.type)
              {
                case node_type.project:
                  s = "p";
                  break;
                case node_type.task:
                  s = "t";
                  break;
                default:
                  s = "p";
                  break;
              }
              title = tree_node.title + " (" + tree_node.id + ", " + tree_node.parent_id + ")";
            }

            var task_style        = "task_" + s;
            var task_btn_style    = "task_btn_" + s;

            var table = document.createElement("table");

            table.setAttribute("border", "0");

            var tr = document.createElement("tr");

            var td = document.createElement("td");

            td.setAttribute("width", tree_node.offset ? tree_node.offset : 0 );

            td.appendChild(document.createTextNode("\xA0"));

            tr.appendChild(td);

            td = document.createElement("td");

            td.setAttribute("class", "task " + task_style);

            var a_href = document.createElement("a");

            a_href.addEventListener("click",
              function(e)
              {
                e.preventDefault();
              }
            );

            a_href.setAttribute("class", "task_btn " + task_btn_style);

            a_href.setAttribute("href", tree_node.id);

            a_href.appendChild(document.createTextNode(title));

            td.appendChild(a_href);

            if (tree_node.id > 0)
            {
              td.appendChild(document.createElement("br"));

              a_href = document.createElement("a");

              a_href.addEventListener("click",
                function(e)
                {
                  e.preventDefault();
                }
              );

              a_href.setAttribute("href", tree_node.id);

              a_href.setAttribute("class", "task_btn task_btn_s");

              a_href.appendChild(document.createTextNode("(new subtask)"));

              td.appendChild(a_href);
            }

            tr.appendChild(td);

            table.appendChild(tr);

            return table;
          }

          post_request().set(
            [
              [ "action", 1 ],
            ],
            function (r)
            {
              var tasks_nodes;

              eval("tasks_nodes = [\n" + r.responseText + "\n];");

              var tasks = tree_store_build_tree(tasks_nodes, cmp);

              /*
                Вообще, функция "tree_store_build_tree"  всегда  завершается  успешно,  за
                исключением случаев когда остаются элементы для которых parent_node  найти
                не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
                время.
              */

              append_nodes(tasks);

              container.appendChild(new_tv_node(tasks));
            }
          );
        },
      };

      window.onload =
        function()
        {
          document.body.appendChild(avgproject.left_right(
            function(a, b)
            {
              return a.priority < b.priority;
            }
          ));
        }
      ;
    //-->
    </script>
  </head>
  <body>
    <versioninfo>
    <h1>AVG Project</h1>
  </body>
</html>

<!-- vim: set expandtab ts=2 : //-->
