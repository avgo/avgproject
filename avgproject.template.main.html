<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AVG Project</title>
    <link rel="stylesheet" type="text/css" href="/toolkit.css"/>
    <style>
    .task {
      border: 1px solid;
      padding: 10px 10px 10px 30px;
      color: #FFFFFF;
      width: 200px;
    }
    .task_field {
      width: 200px;
      height: 40px;
    }
    .task_p {
      background-color: #6666FF;
    }
    .task_t {
      background-color: #9aa9fc;
    }
    .task_btn {
      font-family: Verdana;
      text-decoration: underline;
      cursor: pointer;
    }
    .task_btn_p {
      font-size: 16pt;
      font-weight: bold;
    }
    .task_btn_t {
      font-size: 11pt;
      font-weight: bold;
    }
    .task_btn_s {
      font-size: 8pt;
    }
    .task_btn:hover {
      color: #66FFFF;
    }
    </style>
    <script src="/toolkit.js"></script>
    <script src="/tree_items.js"></script>
    <script>
    <!--
      var app = {
        cmp: function(a,b)
        {
          return a.priority < b.priority;
        },
      };

      function dtm_fmt_def(d)
      {
        return (
          pad(d.getDate()) + "." +
          pad(d.getMonth()+1) + "." +
          pad(d.getFullYear()) + ", " +
          pad(d.getHours()) + ":" +
          pad(d.getMinutes()) + ":" +
          pad(d.getSeconds())
        );
      }

      function get_tasks()
      {
        start_ajax(
          "avgproject.pl?action=1",
          function (r, app)
          {
            var tasks_nodes;

            eval("tasks_nodes = [\n" + r.responseText + "\n];");

            app.tasks = tree_store_build_tree(tasks_nodes, 50, app.cmp);

            /*
              Вообще, функция "tree_store_build_tree" всегда завершается успешно, за
              исключением случаев когда остаются элементы для которых parent_node найти
              не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
              время.
            */

            var main = document.getElementById("main");

            tree_store_html_gen(main, app.tasks);
          },
          app
        );
      }

      function on_load()
      {
        get_tasks(app);
      }

      function projects_tree_view_item_new_subt_click(parent_node)
      {
        var new_node = {
          parent_id: parent_node.id,
        };

        if (app.tasks == parent_node)
        {
          new_node.title        = "Проект";
          new_node.description  = "Описание проекта.";
          new_node.type         = node_type.project;
          new_node.offset       = 0;
        }
        else
        {
          new_node.title        = "задача";
          new_node.description  = "Описание задачи.";
          new_node.type         = node_type.task;
          new_node.offset       = parent_node.offset + app.tasks.offset_step;
        }

        new_node.priority = "";

        start_ajax(
          "avgproject.pl?action=2" +
          "&parent_id=" + new_node.parent_id +
          "&title=" + new_node.title +
          "&description=" + new_node.description +
          "&type=" + new_node.type,
          function (r, args)
          {
            var resp;

            var cmd = "resp = " + r.responseText + ";";

            eval(cmd);

            if (!resp.id) // Произошла ошибка во время добавления на сервере
              return;

            var new_node    = args.new_node;
            var parent_node = args.parent_node;

            new_node.id           = resp.id;
            new_node.dtm_created  = resp.dtm_created;

            tree_store_add(app.tasks, parent_node, new_node, app.cmp);

            projects_tree_view_update(new_node);
          },
          { parent_node: parent_node, new_node: new_node }
        );
      }

      function projects_tree_view_item_project_click(item)
      {
        var task = document.getElementById("task");

        while (task.firstChild)
          task.removeChild(task.firstChild);

        task.appendChild(toolkit_label(
          function(item)
          {
            return item.title;
          },
          function(new_text, item)
          {
            start_ajax(
              "avgproject.pl?action=3" +
              "&id=" + item.id +
              "&title=" + encodeURIComponent(new_text),
              function (r, args)
              {
              },
              { }
            );

            item.title = new_text;

            projects_tree_view_update(item);

            return new_text;
          },
          item
        ).el_main);

        task.appendChild(document.createElement("br"));
        task.appendChild(document.createElement("br"));

        function avgp_task_comment_log_work_data(id,task_id,type,comment,start,min,created,modified)
        {
          return {
            comment:     function() { return comment; },

            start:       function() { return start; },

            get_id:      function() { return id; },

            logged_min:  function() { return min; },

            task_id:     function() { return task_id; },

            x: function(args)
            {
              return start.replace(" ", "T");
            },

            y: function(new_text, args)
            {
              start = new_text.replace("T", " ");
            },
          };
        }

        function avgp_task_comment_log_work_view(handl)
        {
          var tbl = document.createElement("table");

          tbl.style.setProperty("background-color", "#FFA1A1");
          tbl.style.setProperty("border-radius", "8px");
          tbl.style.setProperty("color", "#630000");
          tbl.style.setProperty("width", "500px");

          var tr, td;

          tr = document.createElement("tr");

          td = document.createElement("td");
          td.style.setProperty("padding", "3px 3px 3px 10px");
          td.style.setProperty("text-align", "center");
          td.style.setProperty("width", "150px");
          td.appendChild(toolkit_datetime_picker(
            handl.x,
            handl.y,
            null
          ).el_main);
          tr.appendChild(td);

          function mins_to_hr(lm)
          {
            var h = Math.floor(lm / 60);
            var m = lm % 60;
            if (0)
              return pad(h) + ":" + pad(m);
            else
              return h + "h, " + m + "m";
          }

          td = document.createElement("td");
          td.style.setProperty("border-left", "1px solid rgb(255, 0, 0)");
          td.style.setProperty("font-size", "9pt");
          td.style.setProperty("padding", "0px 15px");
          td.appendChild(
            toolkit_label(
              function()
              {
                return handl.logged_min();
              },
              function()
              {
                return handl.logged_min();
              }
            ).el_main
          );
          tr.appendChild(td);

          tbl.appendChild(tr);

          tr = document.createElement("tr");

          td = document.createElement("td");
          td.setAttribute("colspan", "2");
          td.style.setProperty("border-style", "solid");
          td.style.setProperty("border-width", "1px 0px 0px");
          td.style.setProperty("border-top", "1px solid rgb(255, 0, 0)");
          td.style.setProperty("padding", "5px");
          td.appendChild(document.createTextNode(handl.comment()));
          tr.appendChild(td);

          tbl.appendChild(tr);

          return tbl;
        }

        task.appendChild((function(){
          var tbl = document.createElement("table");

          var arr = [
            [
              "up", (function(item)
              {
                return function ()
                {
                  start_ajax(
                    "avgproject.pl?action=4" +
                    "&id=" + item.id,
                    function (r, args)
                    {
                      var par = item.parent;

                      eval("var resp = { " + r.responseText + " }");

                      item.priority = resp.priority;

                      tree_store_unlink(item, item);
                      tree_store_add(app.tasks, par, item, app.cmp);

                      var bottom_node = tree_store_get_bottom_node(item);

                      var table_bottom = document.getElementById("table_item_" + bottom_node.id);

                      for_each_sibling(item, function (i)
                      {
                        var table = document.getElementById("table_item_" + i.id);

                        table.remove();

                        table_bottom.parentNode.insertBefore(table, table_bottom);
                      });
                    },
                    { }
                  );
                };
              })(item)
            ],
            [
              "log work", (function(task,item)
              {
                return function()
                {
                  var logwork_comment = "text";
                  var logwork_min     = 60;

                  start_ajax(
                    "avgproject.pl?action=5" +
                    "&ins=1" +
                    "&kid=ai" +
                    "&ftask_id=" + item.id +
                    "&fcomment=" + encodeURIComponent(logwork_comment) +
                    "&fstart=now" +
                    "&fmin=" + logwork_min +
                    "&fcreated=0" +
                    "&fmodified=0" +
                    "&select=id,start"
                    ,
                    function (r, args)
                    {
                      var resp;

                      eval("resp = " + r.responseText);

                      if (!resp.result)
                        return;

                      task.appendChild(document.createElement("br"));

                      var el = resp.result[0];

                      task.appendChild(
                        avgp_task_comment_log_work_view(avgp_task_comment_log_work_data(
                          el.id,
                          item.id,
                          el.type,
                          el.comment,
                          el.start,
                          el.min,
                          el.created,
                          el.modified
                        ))
                      );
                    },
                    { }
                  );
                };
              })(task,item)
            ],
            [
              "close", (function(item)
              {
                return function()
                {
                  alert("close \"" + item.title + "\"!");
                };
              })(item)
            ],
          ];

          var tr = document.createElement("tr");

          for (var i = 0; i < arr.length; ++i)
          {
            (function(){
              var td = document.createElement("td");

              var text = arr[i][0];

              var btn = document.createElement("button");

              btn.style.setProperty("background-color", "rgb(215, 240, 255)");
              btn.style.setProperty("border", "0px none");
              btn.style.setProperty("color", "rgb(0, 118, 189)");
              btn.style.setProperty("cursor", "pointer");
              btn.style.setProperty("padding", "4px 40px");

              btn.addEventListener("click", arr[i][1]);

              btn.appendChild(document.createTextNode(text));

              td.appendChild(btn);

              tr.appendChild(td);
            })();
          }

          tbl.appendChild(tr);

          return tbl;
        })());

        task.appendChild(document.createElement("br"));

        function create_tr(tbl, text, node)
        {
          var tr, td;

          tr = document.createElement("tr");

          td = document.createElement("td");
          td.className = "task_field";
          td.appendChild(document.createTextNode(text));
          tr.appendChild(td);

          td = document.createElement("td");
          td.className = "task_field";

          for (var i = 0; i < node.length; ++i)
          {
            td.appendChild(node[i]);
          }

          tr.appendChild(td);

          tbl.appendChild(tr);
        }

        var tbl = document.createElement("table");

        create_tr(tbl, "ID:", [
          document.createTextNode(item.id)
        ]);

        create_tr(tbl, "Parent ID:", [
          document.createTextNode(item.parent_id)
        ]);

        create_tr(tbl, "Дата создания:", [
          toolkit_datetime_picker(
            function(args)
            {
              return args.dtm_created.replace(" ", "T");
            },
            function(new_text, args)
            {
              new_text = new_text.replace("T", " ");
              args.dtm_created = new_text;
            },
            item
          ).el_main,
        ]);

        create_tr(tbl, "Приоритет:", [
          document.createTextNode(
            item.priority ? dtm_fmt_def(
              new Date(item.priority.replace(" ","T"))
            ) : ""
          )
        ]);

        task.appendChild(tbl);

        var elem_textarea = toolkit_memo_create(
          "task_ws_task_description",
          "task_ws_task_description_text_get",
          "task_ws_task_description_text_set",
          "{ id: " + item.id + " }"
        );

        task.appendChild(elem_textarea);

        start_ajax(
          "avgproject.pl?action=6" +
          "&fields=id,type,comment,start,min,created,modified" +
          "&qtask_id=" + item.id
          ,
          function (r, args)
          {
            var resp;

            eval("resp = " + r.responseText);

            task.appendChild(document.createElement("br"));

            task.appendChild(document.createTextNode("Коментарии " + resp.result.length + " штук."));

            task.appendChild(document.createElement("br"));

            var arr = resp.result;

            for (var i = 0; i < arr.length; ++i)
            {
              var el = arr[i];

              task.appendChild(document.createElement("br"));

              task.appendChild(
                avgp_task_comment_log_work_view(avgp_task_comment_log_work_data(
                  el.id,
                  item.id,
                  el.type,
                  el.comment,
                  el.start,
                  el.min,
                  el.created,
                  el.modified
                ))
              );
            }
          },
          { }
        );
      }

      function projects_tree_view_update(node)
      {
        var is_new;

        var table = document.getElementById("table_item_" + node.id);

        if (table)
        {
          is_new = false;
          while (table.firstChild)
            table.removeChild(table.firstChild);
        }
        else
        {
          is_new = true;
          table = document.createElement("table");
          table.id = "table_item_" + node.id;
        }

        table.innerHTML = gen_html_for_node(node);

        if (is_new)
        {
          var bottom_node = tree_store_get_bottom_node(node);

          var table_bottom = document.getElementById("table_item_" + bottom_node.id);

          table_bottom.parentNode.insertBefore(table, table_bottom);
        }
      }

      function start_ajax(url, on_succ, ctx)
      {
        var r = new XMLHttpRequest();

        r.onreadystatechange = function ()
        {
          switch (r.readyState)
          {
          case 4:
            if (r.status == 200)
            {
              on_succ(r, ctx);
            }
            break;
          }
        }

        r.open("GET", url, true);
        r.send("");
      }

      function string_escape_js(s)
      {
        return s.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"").replace(/'/g, "\\'");
      }

      function task_ws_task_description_text_get(args)
      {
        var item = tasks_get_task_by_id(args.id);

        return item.description;
      }

      function task_ws_task_description_text_set(new_text, args)
      {
        start_ajax(
          "avgproject.pl?action=3" +
          "&id=" + args.id +
          "&description=" + encodeURIComponent(new_text),
          function (r, args)
          {
          },
          { }
        );

        var item = tasks_get_task_by_id(args.id);

        item.description = new_text;

        return new_text;
      }

      function tasks_get_task_by_id(id)
      {
        var item;

        eval("item = app.tasks.items.item_" + id + ";");

        return item;
      }

      function toolkit_memo_click(memo_id, text_get, text_set, args)
      {
        var memo_btn_id = memo_id + "_btn";

        var memo_memo_id = memo_id + "_memo";

        var memo_memo = document.getElementById(memo_memo_id);

        var textarea = document.createElement("textarea");

        textarea.style = "width: 800px;";

        while (memo_memo.firstChild)
          memo_memo.removeChild(memo_memo.firstChild);

        var button = document.createElement("input");

        button.type       = "button";
        button.id         = memo_id + "_ok_btn";
        button.className  = "toolkit_small_button";
        button.value      = "ok";

        button.onclick = function ()
        {
          var t;

          eval("t = " + text_set + "(textarea.value, " + args + ");");

          while (memo_memo.firstChild)
            memo_memo.removeChild(memo_memo.firstChild);

          memo_memo.appendChild(document.createTextNode(t));
        };

        memo_memo.appendChild(button);

        var text;

        eval("text = " + text_get + "(" + args + ");");

        textarea.appendChild(document.createTextNode(text));

        memo_memo.appendChild(textarea);

        textarea.focus();
      }

      function toolkit_memo_create(memo_id, text_get, text_set, args)
      {
        var elem_textarea = document.createElement("div");

        elem_textarea.style = "width: 800px;";

        var button = document.createElement("input");

        button.type       = "button";
        button.id         = memo_id + "_btn";
        button.className  = "toolkit_small_button";
        button.value      = "edit";

        button.setAttribute("onclick",
          "toolkit_memo_click('" +
          memo_id + "', '" +
          text_get + "', '" +
          text_set + "', '" +
          args + "');"
        );

        elem_textarea.appendChild(button);

        elem_textarea.appendChild(document.createElement("br"));

        var textarea = document.createElement("div");

        textarea.id = memo_id + "_memo";

        var text;

        eval("text = " + text_get + "(" + args + ");");

        textarea.appendChild(document.createTextNode(text));

        elem_textarea.appendChild(textarea);

        return elem_textarea;
      }
    //-->
    </script>
  </head>
  <body onload="on_load()">
    <versioninfo>
    <h1>AVG Project</h1>
    <table border="0">
      <tr>
        <td style="vertical-align: top; width: 32%;">
          <div id="main"></div>
        </td>
        <td style="vertical-align: top;">
          <div id="task"></div>
        </td>
      </tr>
    </table>
    <div id="log"></div>
  </body>
</html>

<!-- vim: set expandtab ts=2 : //-->
