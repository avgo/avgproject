<html>
  <head>
    <title>AVG Project</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
    .small_button {
      font-size: 11px;
      border: 0px solid rgb(255, 153, 153);
      background-color: transparent;
      cursor: pointer;
      color: rgb(102, 102, 255);
    }
    .task {
      border: 1px solid;
      padding: 10px 10px 10px 30px;
      color: #FFFFFF;
      width: 200px;
    }
    .task_field {
      width: 200px;
      height: 40px;
    }
    .task_p {
      background-color: #6666FF;
    }
    .task_t {
      background-color: #9aa9fc;
    }
    .task_btn {
      font-family: Verdana;
      text-decoration: underline;
      cursor: pointer;
    }
    .task_btn_p {
      font-size: 16pt;
      font-weight: bold;
    }
    .task_btn_t {
      font-size: 11pt;
      font-weight: bold;
    }
    .task_btn_s {
      font-size: 8pt;
    }
    .task_btn:hover {
      color: #66FFFF;
    }
    .toolkit_dtm_picker {
      background-color: rgb(255, 255, 255);
      display: none;
      position: absolute;
      left: 600px;
      top: 230px;
      padding: 8px;
      height: 200px;
      width: 300px;
      border-width: 1px;
      border-color: #000000;
      border-style: solid;
      border-radius: 6px;
    }
    </style>
    <script src="/tree_items.js"></script>
    <script>
    <!--
      var app = {
        cmp: function(a,b)
        {
          return a.priority < b.priority;
        },
      };

      function get_tasks()
      {
        start_ajax(
          "avgproject.pl?action=1",
          function (r, app)
          {
            var tasks_nodes;

            eval("tasks_nodes = [\n" + r.responseText + "\n];");

            app.tasks = tree_store_build_tree(tasks_nodes, 50, app.cmp);

            /*
              Вообще, функция "tree_store_build_tree" всегда завершается успешно, за
              исключением случаев когда остаются элементы для которых parent_node найти
              не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
              время.
            */

            var main = document.getElementById("main");

            tree_store_html_gen(main, app.tasks);
          },
          app
        );
      }

      function log_message(msg)
      {
        var log = document.getElementById("log");

        log.innerHTML += msg;
      }

      function on_load()
      {
        get_tasks(app);
      }

      function pad(n)
      {
        if (n < 10)
          return "0" + n;
        else
          return n;
      }

      function projects_tree_view_item_new_subt_click(parent_node)
      {
        var new_node = {
          parent_id: parent_node.id,
        };

        if (app.tasks == parent_node)
        {
          new_node.title        = "Проект";
          new_node.description  = "Описание проекта.";
          new_node.type         = node_type.project;
          new_node.offset       = 0;
        }
        else
        {
          new_node.title        = "задача";
          new_node.description  = "Описание задачи.";
          new_node.type         = node_type.task;
          new_node.offset       = parent_node.offset + app.tasks.offset_step;
        }

        new_node.priority = "";

        start_ajax(
          "avgproject.pl?action=2" +
          "&parent_id=" + new_node.parent_id +
          "&title=" + new_node.title +
          "&description=" + new_node.description +
          "&type=" + new_node.type,
          function (r, args)
          {
            var resp;

            var cmd = "resp = " + r.responseText + ";";

            eval(cmd);

            if (!resp.id) // Произошла ошибка во время добавления на сервере
              return;

            var new_node    = args.new_node;
            var parent_node = args.parent_node;

            new_node.id           = resp.id;
            new_node.dtm_created  = resp.dtm_created;

            tree_store_add(app.tasks, parent_node, new_node, app.cmp);

            projects_tree_view_update(new_node);
          },
          { parent_node: parent_node, new_node: new_node }
        );
      }

      function projects_tree_view_item_project_click(item)
      {
        var task = document.getElementById("task");

        var item_obj_str = "app.tasks.items.item_" + item.id;

        task.innerHTML =
          toolkit_label(
            "task_ws_task_title",
            "task_ws_task_title_get",
            "task_ws_task_title_set",
            "{ id: " + item.id + " }"
          ) +

          "<input " +
            "type=\"button\" " +
            "class=\"small_button\" " +
            "value=\"up\" " +
            "onclick=\"task_ws_up_click(" + item_obj_str + ");\"" +
          ">\n" +

          "<table>" +
          "<tr>" +
          "<td>" +

          "<table>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">ID:</td>\n" +
          "<td class=\"task_field\">" + item.id + "</td>\n" +
          "</tr>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">Parent ID:</td>\n" +
          "<td class=\"task_field\">" + item.parent_id + "</td>\n" +
          "</tr>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">Дата создания:</td>\n" +
          "<td class=\"task_field\">" + item.dtm_created + "</td>\n" +
          "</tr>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">Приоритет:</td>\n" +
          "<td class=\"task_field\">" + item.priority + "</td>\n" +
          "</tr>\n" +

          "</table>\n" +

          "</td>" +

          "<td id=\"task_ws_work_log\" style=\"vertical-align: top;\">" +
          "</td>" +
          "</tr>" +
          "</table>" +
          ""
        ;

        var elem_textarea = toolkit_memo_create(
          "task_ws_task_description",
          "task_ws_task_description_text_get",
          "task_ws_task_description_text_set",
          "{ id: " + item.id + " }"
        );

        task.appendChild(elem_textarea);

        var work_log = document.getElementById("task_ws_work_log");

        var dtmp = toolkit_datetime_picker(
          "task_ws_task_dtmp",
          "task_ws_task_dtmp_text_get",
          "task_ws_task_dtmp_text_set",
          "{ id: " + item.id + " }"
        );

        work_log.appendChild(dtmp);
      }

      function projects_tree_view_update(node)
      {
        var is_new;

        var table = document.getElementById("table_item_" + node.id);

        if (table)
        {
          is_new = false;
          while (table.firstChild)
            table.removeChild(table.firstChild);
        }
        else
        {
          is_new = true;
          table = document.createElement("table");
          table.id = "table_item_" + node.id;
        }

        table.innerHTML = gen_html_for_node(node);

        if (is_new)
        {
          var bottom_node = tree_store_get_bottom_node(node);

          var table_bottom = document.getElementById("table_item_" + bottom_node.id);

          table_bottom.parentNode.insertBefore(table, table_bottom);
        }
      }

      function start_ajax(url, on_succ, ctx)
      {
        var r = new XMLHttpRequest();

        r.onreadystatechange = function ()
        {
          switch (r.readyState)
          {
          case 4:
            if (r.status == 200)
            {
              on_succ(r, ctx);
            }
            break;
          }
        }

        r.open("GET", url, true);
        r.send("");
      }

      function string_escape_js(s)
      {
        return s.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"").replace(/'/g, "\\'");
      }

      function task_ws_task_description_text_get(args)
      {
        var item = tasks_get_task_by_id(args.id);

        return item.description;
      }

      function task_ws_task_description_text_set(new_text, args)
      {
        start_ajax(
          "avgproject.pl?action=3" +
          "&id=" + args.id +
          "&description=" + encodeURIComponent(new_text),
          function (r, args)
          {
          },
          { }
        );

        var item = tasks_get_task_by_id(args.id);

        item.description = new_text;

        return new_text;
      }

      function task_ws_task_dtmp_text_get(args)
      {
        var d = new Date();

        var item = tasks_get_task_by_id(args.id);

        return item.dtm_created.replace(" ","T");
      }

      function task_ws_task_dtmp_text_set(title_get, new_text, args)
      {
        alert(new_text);
      }

      function task_ws_task_title_get(args)
      {
        var item = tasks_get_task_by_id(args.id);

        return item.title;
      }

      function task_ws_task_title_set(title_get, new_title, args)
      {
        start_ajax(
          "avgproject.pl?action=3" +
          "&id=" + args.id +
          "&title=" + encodeURIComponent(new_title),
          function (r, args)
          {
          },
          { }
        );

        var item = tasks_get_task_by_id(args.id);

        item.title = new_title;

        projects_tree_view_update(item);

        return new_title;
      }

      function task_ws_up_click(item)
      {
        start_ajax(
          "avgproject.pl?action=4" +
          "&id=" + item.id,
          function (r, args)
          {
            var par = item.parent;

            eval("var resp = { " + r.responseText + " }");

            item.priority = resp.priority;

            tree_store_unlink(item, item);
            tree_store_add(app.tasks, par, item, app.cmp);

            function for_each_sibling(parent, f, arg)
            {
              f(parent, arg); for_each_sibling_sibling(parent,f,arg);
            }

            function for_each_sibling_sibling(parent, f, arg)
            {
              for (var i = parent.first; i; i = i.next)
              {
                f(i); for_each_sibling_sibling(i,f,arg);
              }
            }

            var bottom_node = tree_store_get_bottom_node(item);

            var table_bottom = document.getElementById("table_item_" + bottom_node.id);

            for_each_sibling(item, function (i)
            {
              var table = document.getElementById("table_item_" + i.id);

              table.remove();

              table_bottom.parentNode.insertBefore(table, table_bottom);
            });
          },
          { }
        );
      }

      function tasks_get_task_by_id(id)
      {
        var item;

        eval("item = app.tasks.items.item_" + id + ";");

        return item;
      }

      var toolkit_datetime_picker_scroll = function(e)
      {
        if (e.deltaY < 0)
          ++this.value;
        else if (e.deltaY > 0)
          --this.value;
      };

      function toolkit_datetime_picker(dtmp_id, text_get, text_set, args)
      {
        var dtmp = document.createElement("span");

        var dtmp_dtmp = document.createElement("span");

        dtmp_dtmp.id = dtmp_id;

        dtmp_dtmp.setAttribute("onclick",
          "toolkit_datetime_picker_onclick('" +
          dtmp_id + "','" + text_get + "','" + text_set + "','" + args + "');"
        );

        var title;

        eval("title = " + text_get + "(" + args + ");");

        dtmp_dtmp.appendChild(document.createTextNode(title));

        dtmp.appendChild(dtmp_dtmp);

        var popup_win = document.createElement("div");

        popup_win.className = "toolkit_dtm_picker";

        popup_win.id = dtmp_id + "_popup_win";

        var btn_close = document.createElement("input");

        btn_close.className  = "small_button";
        btn_close.type       = "button";
        btn_close.value      = "close";

        btn_close.setAttribute("onclick",
          "toolkit_datetime_picker_close_popup(" +
          "'" + popup_win.id + "'" +
          ");"
        );

        popup_win.appendChild(btn_close);

        var btn_set = document.createElement("input");

        btn_set.className  = "small_button";
        btn_set.type       = "button";
        btn_set.value      = "set";

        btn_set.setAttribute("onclick",
          "toolkit_datetime_picker_set(" +
          "'" + dtmp_id + "'," +
          "'" + text_set + "'," +
          "'" + args + "'" +
          ");"
        );

        popup_win.appendChild(btn_set);

        popup_win.appendChild(document.createElement("br"));

        var year_pick = document.createElement("input");

        year_pick.id = dtmp_id + "_year_pick";
        year_pick.type = "text";
        year_pick.value = "YYYY";
        year_pick.style.setProperty("width", "45px");
        year_pick.style.setProperty("text-align", "center");
        year_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(year_pick);

        popup_win.appendChild(document.createTextNode("-"));

        var month_pick = document.createElement("input");

        month_pick.id = dtmp_id + "_month_pick";
        month_pick.type = "text";
        month_pick.value = "MM";
        month_pick.style.setProperty("width", "30px");
        month_pick.style.setProperty("text-align", "center");
        month_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(month_pick);

        popup_win.appendChild(document.createTextNode("-"));

        var day_pick = document.createElement("input");

        day_pick.id = dtmp_id + "_day_pick";
        day_pick.type = "text";
        day_pick.value = "DD";
        day_pick.style.setProperty("width", "30px");
        day_pick.style.setProperty("text-align", "center");
        day_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(day_pick);

        popup_win.appendChild(document.createTextNode(" "));

        var hours_pick = document.createElement("input");

        hours_pick.id = dtmp_id + "_hours_pick";
        hours_pick.type = "text";
        hours_pick.value = "HH";
        hours_pick.style.setProperty("width", "30px");
        hours_pick.style.setProperty("text-align", "center");
        hours_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(hours_pick);

        popup_win.appendChild(document.createTextNode(":"));

        var minutes_pick = document.createElement("input");

        minutes_pick.id = dtmp_id + "_minutes_pick";
        minutes_pick.type = "text";
        minutes_pick.value = "MM";
        minutes_pick.style.setProperty("width", "30px");
        minutes_pick.style.setProperty("text-align", "center");
        minutes_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(minutes_pick);

        popup_win.appendChild(document.createTextNode(":"));

        var seconds_pick = document.createElement("input");

        seconds_pick.id = dtmp_id + "_seconds_pick";
        seconds_pick.type = "text";
        seconds_pick.value = "SS";
        seconds_pick.style.setProperty("width", "30px");
        seconds_pick.style.setProperty("text-align", "center");
        seconds_pick.addEventListener("wheel", toolkit_datetime_picker_scroll);

        popup_win.appendChild(seconds_pick);

        popup_win.appendChild(document.createElement("br"));

        var date_pick = document.createElement("span");

        date_pick.id = dtmp_id + "_dp";

        popup_win.appendChild(date_pick);

        dtmp.appendChild(popup_win);

        return dtmp;
      }

      function toolkit_datetime_picker_close_popup(dtmp_popup_id)
      {
        var dtmp_popup = document.getElementById(dtmp_popup_id);

        dtmp_popup.style.setProperty("display", "none");
      }

      function toolkit_datetime_picker_dp_update(dp,d)
      {
        function date_to_str(d)
        {
          var wdd = [
            "понедельник",
            "вторник",
            "среда",
            "четверг",
            "пятница",
            "суббота",
            "воскресенье"
          ];

          wdd = [
            "ПН", "ВТ", "СР", "ЧТ", "ПТ", "СБ", "ВС"
          ];

          return "" +
            pad(d.getFullYear()) + "-" +
            pad(d.getMonth()+1) + "-" +
            pad(d.getDate()) + " " +
            pad(d.getHours()) + ":" +
            pad(d.getMinutes()) + ":" +
            pad(d.getSeconds()) + ", " +
            d.getTime() + ", " + wdd[(d.getDay()+6)%7]
          ;
        }

        while(dp.firstChild)
          dp.removeChild(dp.firstChild);

        var t = document.createElement("table");

        t.border = 0;

        var dtm_min = new Date(d.getFullYear(),d.getMonth(),1);

        var dtm_min_time = dtm_min.getTime() - ((dtm_min.getDay() + 6) % 7)*24*60*60*1000;

        for (var i = 0; i < 6; ++i)
        {
          var tr = document.createElement("tr");

          for (var j = 0; j < 7; ++j)
          {
            var td = document.createElement("td");

            dtm_min.setTime(dtm_min_time);

            var btn = document.createElement("input");

            btn.type   = "button";
            btn.value  = dtm_min.getDate();

            btn.style.setProperty("width","25px");
            btn.style.setProperty("text-align","right");
            btn.style.setProperty("background-color","#ffffff");
            btn.style.setProperty("border-width", "1px");
            btn.style.setProperty("padding", "0px 0px 0px 0px");

            btn.setAttribute("onclick", "toolkit_datetime_picker_pick_date('" + dp.id + "'," + dtm_min.getFullYear() + "," + dtm_min.getMonth() + "," + dtm_min.getDate() + ");");

            td.appendChild(btn);

            tr.appendChild(td);

            dtm_min_time += 24*60*60*1000;
          }

          t.appendChild(tr);
        }

        dp.appendChild(t);
      }

      function toolkit_datetime_picker_onclick(dtmp_id, text_get, text_set, args)
      {
        var dtmp = document.getElementById(dtmp_id);

        var dtmp_popup = document.getElementById(dtmp_id + "_popup_win");

        var text; eval("text = " + text_get + "(" + args + ");");
        var d = new Date(text);

        var year_pick = document.getElementById(dtmp_id + "_year_pick");
        year_pick.value = d.getFullYear();

        var month_pick = document.getElementById(dtmp_id + "_month_pick");
        month_pick.value = d.getMonth() + 1;

        var day_pick = document.getElementById(dtmp_id + "_day_pick");
        day_pick.value = d.getDate();

        var hours_pick = document.getElementById(dtmp_id + "_hours_pick");
        hours_pick.value = d.getHours();

        var minutes_pick = document.getElementById(dtmp_id + "_minutes_pick");
        minutes_pick.value = d.getMinutes();

        var seconds_pick = document.getElementById(dtmp_id + "_seconds_pick");
        seconds_pick.value = d.getSeconds();

        var dtmp_dp = document.getElementById(dtmp_id + "_dp");

        toolkit_datetime_picker_dp_update(dtmp_dp,d);

        var br = dtmp.getBoundingClientRect();

        dtmp_popup.style.setProperty("left", br.left + "px");

        dtmp_popup.style.setProperty("top", (br.top + 20) + "px");

        dtmp_popup.style.setProperty("display", "block");
      }

      function toolkit_datetime_picker_pick_date(dtmp_id, year, month, day)
      {
      }

      function toolkit_datetime_picker_set(dtmp_id, text_set, args)
      {
        var year_pick = document.getElementById(dtmp_id + "_year_pick");
        var month_pick = document.getElementById(dtmp_id + "_month_pick");
        var day_pick = document.getElementById(dtmp_id + "_day_pick");
        var hours_pick = document.getElementById(dtmp_id + "_hours_pick");
        var minutes_pick = document.getElementById(dtmp_id + "_minutes_pick");
        var seconds_pick = document.getElementById(dtmp_id + "_seconds_pick");

        var new_title =
          year_pick.value + "-" +
          month_pick.value + "-" +
          day_pick.value + "T" +
          hours_pick.value + ":" +
          minutes_pick.value + ":" +
          seconds_pick.value
        ;

        eval(text_set + "('','" + new_title + "'," + args + ");");
      }

      function toolkit_label(label_id, title_get, title_set, args)
      {
        var label_label_id = label_id + "_label";

        var label_btn_id = label_id + "_btn";

        var title;

        eval("title = " + title_get + "(" + args + ");");

        return (
          "<div>" +
          "<span id=\"" + label_label_id + "\" style=\"font-size: 24px;\">" +
          title +
          "</span>\n" +
          "<input " +
            "type=\"button\" " +
            "id=\"" + label_btn_id + "\" " +
            "class=\"small_button\" " +
            "value=\"edit\" " +
            "onclick=\"" + toolkit_label_handler(label_id, title_get, title_set, args) + "\"" +
          ">" +
          "</div>\n" +
          ""
        );
      }

      function toolkit_label_click_1(label_id, title_get, title_set, args)
      {
        var label_label_id = label_id + "_label";

        var label_label = document.getElementById(label_label_id);

        var label_btn_id = label_id + "_btn";

        var label_btn = document.getElementById(label_btn_id);

        var label_edit_id = label_id + "_edit";

        label_label.innerHTML =
          "<input id=\"" + label_edit_id + "\" type=\"text\">";

        var label_edit = document.getElementById(label_edit_id);

        var title;

        eval("title = " + title_get + "(" + args + ");");

        label_edit.addEventListener("keyup", function (event)
          {
            event.preventDefault();
            if (event.keyCode != 13)
              return;

            var r;

            var new_title = label_edit.value;

            var code = "r = " + title_set + "('" +
              title_get + "', '" +
              string_escape_js(new_title) + "', " +
              args + ");";

            eval(code);

            while (label_label.firstChild)
              label_label.removeChild(label_label.firstChild);

            label_label.appendChild(document.createTextNode(r));
          }
        );

        label_edit.value = title;

        label_edit.focus();

        label_edit.selectionStart  = 0;
        label_edit.selectionEnd    = label_edit.value.length;
      }

      function toolkit_label_handler(label_id, title_get, title_set, args)
      {
        return "toolkit_label_click_1('" + label_id + "', '" + title_get + "', '" + title_set + "', '" + args + "')";
      }

      function toolkit_memo_click(memo_id, text_get, text_set, args)
      {
        var memo_btn_id = memo_id + "_btn";

        var memo_memo_id = memo_id + "_memo";

        var memo_memo = document.getElementById(memo_memo_id);

        var textarea = document.createElement("textarea");

        textarea.style = "width: 800px;";

        while (memo_memo.firstChild)
          memo_memo.removeChild(memo_memo.firstChild);

        var button = document.createElement("input");

        button.type       = "button";
        button.id         = memo_id + "_ok_btn";
        button.className  = "small_button";
        button.value      = "ok";

        button.onclick = function ()
        {
          var t;

          eval("t = " + text_set + "(textarea.value, " + args + ");");

          while (memo_memo.firstChild)
            memo_memo.removeChild(memo_memo.firstChild);

          memo_memo.appendChild(document.createTextNode(t));
        };

        memo_memo.appendChild(button);

        var text;

        eval("text = " + text_get + "(" + args + ");");

        textarea.appendChild(document.createTextNode(text));

        memo_memo.appendChild(textarea);

        textarea.focus();
      }

      function toolkit_memo_create(memo_id, text_get, text_set, args)
      {
        var elem_textarea = document.createElement("div");

        elem_textarea.style = "width: 800px;";

        var button = document.createElement("input");

        button.type       = "button";
        button.id         = memo_id + "_btn";
        button.className  = "small_button";
        button.value      = "edit";

        button.setAttribute("onclick",
          "toolkit_memo_click('" +
          memo_id + "', '" +
          text_get + "', '" +
          text_set + "', '" +
          args + "');"
        );

        elem_textarea.appendChild(button);

        elem_textarea.appendChild(document.createElement("br"));

        var textarea = document.createElement("div");

        textarea.id = memo_id + "_memo";

        var text;

        eval("text = " + text_get + "(" + args + ");");

        textarea.appendChild(document.createTextNode(text));

        elem_textarea.appendChild(textarea);

        return elem_textarea;
      }
    //-->
    </script>
  </head>
  <body onload="on_load()">
    <h1>AVG Project</h1>
    <table border="0">
      <tr>
        <td style="vertical-align: top; width: 32%;">
          <div id="main"></div>
        </td>
        <td style="vertical-align: top;">
          <div id="task"></div>
        </td>
      </tr>
    </table>
    <div id="log"></div>
  </body>
</html>

<!-- vim: set expandtab ts=2 : //-->
