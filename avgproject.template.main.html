<html>
  <head>
    <title>AVG Project</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
    .small_button {
      font-size: 11px;
      border: 0px solid rgb(255, 153, 153);
      background-color: transparent;
      cursor: pointer;
      color: rgb(102, 102, 255);
    }
    .task {
      border: 1px solid;
      padding: 10px 10px 10px 30px;
      color: #FFFFFF;
      width: 200px;
    }
    .task_field {
      width: 200px;
      height: 40px;
    }
    .task_p {
      background-color: #6666FF;
    }
    .task_t {
      background-color: #9aa9fc;
    }
    .task_btn {
      font-family: Verdana;
      text-decoration: underline;
      cursor: pointer;
    }
    .task_btn_p {
      font-size: 16pt;
      font-weight: bold;
    }
    .task_btn_t {
      font-size: 11pt;
      font-weight: bold;
    }
    .task_btn_s {
      font-size: 8pt;
    }
    .task_btn:hover {
      color: #66FFFF;
    }
    </style>
    <script src="/tree_items.js"></script>
    <script>
    <!--
      var app = { };

      function string_escape_js(s)
      {
        return s.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"").replace(/'/g, "\\'");
      }

      function get_tasks()
      {
        start_ajax(
          "avgproject.pl?action=1",
          function (r, app)
          {
            var tasks_code = "app.tasks = [\n" + r.responseText + "];";

            eval(tasks_code);

            app.tasks = tree_store_build_tree(app.tasks);

            /*
              Вообще, функция "tree_store_build_tree" всегда завершается успешно, за
              исключением случаев когда остаются элементы для которых parent_node найти
              не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
              время.
            */

            var main = document.getElementById("main");

            app.items = {
              offset_step: 50,
            };

            tree_store_html_gen(main, app.tasks, app.items);
          },
          app
        );
      }

      function log_message(msg)
      {
            var log = document.getElementById("log");

            log.innerHTML += msg;
      }

      function on_load()
      {
        get_tasks(app);
      }

      function add_new_task(parent_node, new_node)
      {
        start_ajax(
          "avgproject.pl?action=2" +
          "&parent_id=" + new_node.parent_id +
          "&title=" + new_node.title +
          "&type=" + new_node.type,
          function (r, args)
          {
            var resp;

            var cmd = "resp = " + r.responseText + ";";

            eval(cmd);

            if (!resp.id) // Произошла ошибка во время добавления на сервере
              return;

            args.new_node.id           = resp.id;
            args.new_node.dtm_created  = resp.dtm_created;

            var prev = tree_store_add(args.parent_node, args.new_node);

            eval("app.items.item_" + args.new_node.id + " = args.new_node;");

            var table_new = document.createElement("table");

            table_new.id = "table_item_" + args.new_node.id;

            table_new.innerHTML = gen_html_for_node(args.new_node);

            /*
              Осталось вставить новый html в нужном месте
              prev  next
              NULL        Вставить самым первым дочерним элементом
              NULL  NULL  Вставить единственным дочерним элементом
                    NULL  Вставить последним дочерним элементом
                          Вставить между prev и next
            */

            var bn = tree_store_get_bottom_node(args.new_node);

            var table = document.getElementById("table_item_" + bn.id);

            table.parentNode.insertBefore(table_new, table);
          },
          { parent_node: parent_node, new_node: new_node }
        );

        return new_node;
      }

      function projects_tree_item_new_subt_click(parent_node)
      {
        var new_node = {
          parent_id:  parent_node.id,
        };

        if (app.tasks == parent_node)
        {
          new_node.title  = "Проект";
          new_node.type   = node_type.project;
          new_node.offset = 0;
        }
        else
        {
          new_node.title  = "задача";
          new_node.type   = node_type.task;
          new_node.offset = parent_node.offset + app.items.offset_step;
        }

        add_new_task(parent_node, new_node);
      }

      function avgtk_label_click_1(label_id, title_get, title_set, args)
      {
        var label_label_id = label_id + "_label";

        var label_label = document.getElementById(label_label_id);

        var label_btn_id = label_id + "_btn";

        var label_btn = document.getElementById(label_btn_id);

        var label_edit_id = label_id + "_edit";

        label_label.innerHTML =
          "<input id=\"" + label_edit_id + "\" type=\"text\">";

        var label_edit = document.getElementById(label_edit_id);

        var title;

        eval("title = " + title_get + "(" + args + ");");

        label_edit.addEventListener("keyup", function (event)
          {
            event.preventDefault();
            if (event.keyCode != 13)
              return;

            var r;

            var new_title = label_edit.value;

            var code = "r = " + title_set + "('" +
              title_get + "', '" +
              string_escape_js(new_title) + "', " +
              args + ");";

            eval(code);

            while (label_label.firstChild)
              label_label.removeChild(label_label.firstChild);

            label_label.appendChild(document.createTextNode(r));
          }
        );

        label_edit.value = title;

        label_edit.focus();

        label_edit.selectionStart  = 0;
        label_edit.selectionEnd    = label_edit.value.length;
      }

      function avgtk_label(label_id, title_get, title_set, args)
      {
        var label_label_id = label_id + "_label";

        var label_btn_id = label_id + "_btn";

        var title;

        eval("title = " + title_get + "(" + args + ");");

        return (
          "<div>" +
          "<span id=\"" + label_label_id + "\" style=\"font-size: 24px;\">" +
          title +
          "</span>\n" +
          "<input " +
            "type=\"button\" " +
            "id=\"" + label_btn_id + "\" " +
            "class=\"small_button\" " +
            "value=\"edit\" " +
            "onclick=\"" + avgtk_label_handler(label_id, title_get, title_set, args) + "\"" +
          ">" +
          "</div>\n" +
          ""
        );
      }

      function avgtk_label_handler(label_id, title_get, title_set, args)
      {
        return "avgtk_label_click_1('" + label_id + "', '" + title_get + "', '" + title_set + "', '" + args + "')";
      }

      function task_ws_task_title_get(args)
      {
        var item;

        eval("item = app.items.item_" + args.id + ";");

        return item.title;
      }

      function task_ws_task_title_set(title_get, new_title, args)
      {
        var item;

        eval("item = app.items.item_" + args.id + ";");

        item.title = new_title;

        return new_title;
      }

      function projects_tree_item_project_click(item)
      {
        var task = document.getElementById("task");

        task.innerHTML =
          avgtk_label(
            "task_ws_task_title",
            "task_ws_task_title_get",
            "task_ws_task_title_set",
            "{ id: " + item.id + " }"
          ) +

          "<table>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">ID:</td>\n" +
          "<td class=\"task_field\">" + item.id + "</td>\n" +
          "</tr>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">Parent ID:</td>\n" +
          "<td class=\"task_field\">" + item.parent_id + "</td>\n" +
          "</tr>\n" +

          "<tr>\n" +
          "<td class=\"task_field\">Дата создания:</td>\n" +
          "<td class=\"task_field\">" + item.dtm_created + "</td>\n" +
          "</tr>\n" +

          "</table>\n" +
          ""
        ;
      }

      function start_ajax(url, on_succ, ctx)
      {
        var r = new XMLHttpRequest();

        r.onreadystatechange = function ()
        {
          switch (r.readyState)
          {
          case 4:
            if (r.status == 200)
            {
              on_succ(r, ctx);
            }
            break;
          }
        }

        r.open("GET", url, true);
        r.send("");
      }
    //-->
    </script>
  </head>
  <body onload="on_load()">
    <h1>AVG Project</h1>
    <table border="0">
      <tr>
        <td style="vertical-align: top; width: 32%;">
          <div id="main"></div>
        </td>
        <td style="vertical-align: top;">
          <div id="task"></div>
        </td>
      </tr>
    </table>
    <div id="log"></div>
  </body>
</html>

<!-- vim: set expandtab ts=2 : //-->
