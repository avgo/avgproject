<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AVG Project</title>
    <link rel="stylesheet" type="text/css" href="%SITE_DOC_DIR%toolkit.css"/>
    <style>
    .task {
      border: 1px solid;
      padding: 10px 10px 10px 30px;
      color: #FFFFFF;
      width: 200px;
    }
    .task_field {
      width: 200px;
      height: 40px;
    }
    .task_p {
      background-color: #6666FF;
    }
    .task_t {
      background-color: #9aa9fc;
    }
    .task_btn {
      color: #FFFFFF;
      font-family: Verdana;
    }
    .task_btn_p {
      font-size: 16pt;
      font-weight: bold;
    }
    .task_btn_t {
      font-size: 11pt;
      font-weight: bold;
    }
    .task_btn_s {
      font-size: 8pt;
    }
    .task_btn:hover {
      color: #66FFFF;
    }
    </style>
    <script src="%SITE_DOC_DIR%toolkit.js"></script>
    <script src="%SITE_DOC_DIR%tree_items.js"></script>
    <script>
    <!--
      function dtm_fmt_def(d)
      {
        return (
          pad(d.getDate()) + "." +
          pad(d.getMonth()+1) + "." +
          pad(d.getFullYear()) + ", " +
          pad(d.getHours()) + ":" +
          pad(d.getMinutes()) + ":" +
          pad(d.getSeconds())
        );
      }

      function post_request(url, arr1)
      {
        if (!url)
          url = "";

        var query1 = ""; var amp1 = 0;

        function append(arr)
        {
          return arr[0] + "=" + encodeURIComponent(arr[1]);
        }

        if (arr1)
        {
          for (var i = 0; i < arr1.length; ++i)
          {
            if (amp1)
              query1 += "&";
            else
              amp1 = 1;
            query1 += append(arr1[i]);
          }
        }

        return {
          set: function(arr2, success)
          {
            var query2 = query1; var amp2 = amp1;

            for (var i = 0; i < arr2.length; ++i)
            {
              if (amp2)
                query2 += "&";
              else
                amp2 = 1;
              query2 += append(arr2[i]);
            }
            var r = new XMLHttpRequest();
            r.onreadystatechange = function ()
            {
              switch (r.readyState)
              {
              case 4:
                if (r.status == 200)
                  success(r);
                else
                  alert("request error.");
                break;
              }
            }
            r.open("POST", url, true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.send(query2);
          },
        };
      }

      var avgproject =
      {
        comment: function (comment, task_id)
        {
          var updater = post_request(
            "",
            [
              [ "action",  7           ],
              [ "kid",     comment.id  ],
            ]
          );

          var tbl = document.createElement("table");

          tbl.style.setProperty("background-color", "#FFA1A1");
          tbl.style.setProperty("border-radius", "8px");
          tbl.style.setProperty("color", "#630000");
          tbl.style.setProperty("width", "500px");

          var tr, td;

          tr = document.createElement("tr");

          td = document.createElement("td");
          td.style.setProperty("padding", "3px 3px 3px 10px");
          td.style.setProperty("text-align", "center");
          td.style.setProperty("width", "150px");
          var dtmp_start_d = toolkit_datetime_picker(
            function()
            {
              return comment.start_d;
            },
            function(new_text)
            {
              new_text = new_text.replace(/T.*/, '');
              updater.set(
                [
                  [ "fstart_d", new_text ],
                ],
                function()
                {
                  comment.start_d = new_text;
                  dtmp_start_d.update();
                }
              );
            }
          );
          td.appendChild(dtmp_start_d.element());
          tr.appendChild(td);

          td = document.createElement("td");
          td.style.setProperty("border-left", "1px solid rgb(255, 0, 0)");
          td.style.setProperty("font-size", "9pt");
          td.style.setProperty("padding", "3px 3px 3px 10px");
          td.style.setProperty("text-align", "center");
          td.style.setProperty("width", "100px");
          var label_hms_start_t = toolkit_label_hms(
            function ()
            {
              return comment.start_t;
            },
            function (text)
            {
              updater.set(
                [
                  [ "fstart_t", text ],
                ],
                function()
                {
                  comment.start_t = text;
                  label_hms_start_t.update();
                }
              );
            }
          );
          td.appendChild(label_hms_start_t.element());
          tr.appendChild(td);

          td = document.createElement("td");
          td.style.setProperty("border-left", "1px solid rgb(255, 0, 0)");
          td.style.setProperty("font-size", "9pt");
          td.style.setProperty("padding", "0px 15px");

          var lbl_hm_min = toolkit_label_hm(
            function ()
            {
              return comment.min;
            },
            function (text)
            {
              updater.set(
                [
                  [ "fmin", text ],
                ],
                function()
                {
                  comment.min = text;
                  lbl_hm_min.update();
                }
              );
            }
          );

          td.appendChild(lbl_hm_min.element());
          tr.appendChild(td);

          tbl.appendChild(tr);

          tr = document.createElement("tr");

          td = document.createElement("td");
          td.setAttribute("colspan", "3");
          td.style.setProperty("border-style", "solid");
          td.style.setProperty("border-width", "1px 0px 0px");
          td.style.setProperty("border-top", "1px solid rgb(255, 0, 0)");
          td.style.setProperty("padding", "5px");
          var memo_comment = toolkit_memo_create(
            function ()
            {
              return comment.comment;
            },
            function (t)
            {
              updater.set(
                [
                  [ "fcomment", t ],
                ],
                function()
                {
                  comment.comment = t;
                  memo_comment.update();
                }
              );
            }
          );
          td.appendChild(memo_comment.element());
          tr.appendChild(td);

          tbl.appendChild(tr);

          return tbl;
        },
        left_right: function(cmp)
        {
          var table = document.createElement("table");

          table.setAttribute("border", "0");

          var tr = document.createElement("tr");

          var td_tvt = document.createElement("td");

          td_tvt.style.setProperty("vertical-align", "top");
          td_tvt.style.setProperty("width", "32%");

          tr.appendChild(td_tvt);

          var td = document.createElement("td");

          td.setAttribute("id", "task");

          td.style.setProperty("vertical-align", "top");

          tr.appendChild(td);

          table.appendChild(tr);

          avgproject.tree_view_tasks(td_tvt, td, 50, cmp);

          return table;
        },
        task_ws: function(task, item)
        {
          while (task.firstChild)
            task.removeChild(task.firstChild);

          var lbl_title = toolkit_label(
            function()
            {
              return item.title;
            },
            function(new_text)
            {
              post_request().set(
                [
                  [ "action", 3        ],
                  [ "id",     item.id  ],
                  [ "title",  new_text ],
                ],
                function (r)
                {
                  item.title = new_text;
                  lbl_title.update();
                }
              );
            }
          );
          task.appendChild(lbl_title.element());

          task.appendChild(document.createElement("br"));
          task.appendChild(document.createElement("br"));

          task.appendChild(avgproject.toolbar(
            [
              [
                "up",
                function ()
                {
                  post_request().set(
                    [
                      [ "action",  4       ],
                      [ "id",      item.id ],
                    ],
                    function (r)
                    {
                      var par = item.parent;

                      var resp;

                      eval("resp = { " + r.responseText + " }");

                      item.priority = resp.priority;

                      tree_store_unlink(item, item);
                      tree_store_add(app.tasks, par, item, app.cmp);

                      var bottom_node = tree_store_get_bottom_node(item);

                      var table_bottom = document.getElementById("table_item_" + bottom_node.id);

                      for_each_sibling(item,
                        function (i)
                        {
                          var table = document.getElementById("table_item_" + i.id);

                          table.remove();

                          table_bottom.parentNode.insertBefore(table, table_bottom);
                        }
                      );
                    }
                  );
                }
              ],
              [
                "log work",
                function()
                {
                  var logwork_comment = "text";
                  var logwork_min     = 60;

                  post_request().set(
                    [
                      [ "action",    5                ],
                      [ "kid",       "ai"             ],
                      [ "ftask_id",  item.id          ],
                      [ "fcomment",  logwork_comment  ],
                      [ "fstart_d",  "now"            ],
                      [ "fstart_t",  "now"            ],
                      [ "fmin",      logwork_min      ],
                      [ "select",    "id,start"       ],
                    ],
                    function (r)
                    {
                      var resp;

                      eval("resp = " + r.responseText);

                      if (!resp.result)
                        return;

                      task.appendChild(document.createElement("br"));

                      var el = resp.result[0];

                      task.appendChild(
                        avgproject.comment(el, item.id)
                      );
                    }
                  );
                }
              ],
              [
                "close",
                function()
                {
                  alert("close \"" + item.title + "\"!");
                }
              ],
            ]
          ));

          task.appendChild(document.createElement("br"));

          function create_tr(tbl, text, node)
          {
            var tr, td;

            tr = document.createElement("tr");

            td = document.createElement("td");
            td.className = "task_field";
            td.appendChild(document.createTextNode(text));
            tr.appendChild(td);

            td = document.createElement("td");
            td.className = "task_field";

            for (var i = 0; i < node.length; ++i)
            {
              td.appendChild(node[i]);
            }

            tr.appendChild(td);

            tbl.appendChild(tr);
          }

          var tbl = document.createElement("table");

          create_tr(tbl, "ID:", [
            document.createTextNode(item.id)
          ]);

          create_tr(tbl, "Parent ID:", [
            document.createTextNode(item.parent_id)
          ]);

          var dtmp_created = toolkit_datetime_picker(
            function()
            {
              return item.dtm_created.replace(" ", "T");
            },
            function(new_text)
            {
              new_text = new_text.replace("T", " ");
              item.dtm_created = new_text;
              dtmp_created.update();
            }
          );

          create_tr(tbl, "Дата создания:", [ dtmp_created.element() ]);

          create_tr(tbl, "Приоритет:", [
            document.createTextNode(
              item.priority ? dtm_fmt_def(
                new Date(item.priority.replace(" ","T"))
              ) : ""
            )
          ]);

          task.appendChild(tbl);

          var memo_desc = toolkit_memo_create(
            function()
            {
              return item.description;
            },
            function(v)
            {
              post_request().set(
                [
                  [ "action",      3       ],
                  [ "id",          item.id ],
                  [ "description", v       ],
                ],
                function ()
                {
                  item.description = v;
                  memo_desc.update();
                }
              );
            }
          );

          task.appendChild(memo_desc.element());

          post_request().set(
            [
              [ "action",    6        ],
              [ "fields",    "id,type,comment,start_d,start_t,min,created,modified" ],
              [ "qtask_id",  item.id  ],
            ],
            function (r)
            {
              var resp;

              eval("resp = " + r.responseText);

              task.appendChild(document.createElement("br"));

              task.appendChild(document.createTextNode("Коментарии " + resp.result.length + " штук."));

              task.appendChild(document.createElement("br"));

              var arr = resp.result;

              for (var i = 0; i < arr.length; ++i)
              {
                var el = arr[i];

                task.appendChild(document.createElement("br"));

                task.appendChild(
                  avgproject.comment(el, item.id)
                );
              }
            }
          );
        },
        toolbar: function (arr)
        {
          var tbl = document.createElement("table");

          var tr = document.createElement("tr");

          for (var i = 0; i < arr.length; ++i)
          {
            var td = document.createElement("td");

            var text = arr[i][0];

            var btn = document.createElement("button");

            btn.style.setProperty("background-color", "rgb(215, 240, 255)");
            btn.style.setProperty("border", "0px none");
            btn.style.setProperty("color", "rgb(0, 118, 189)");
            btn.style.setProperty("cursor", "pointer");
            btn.style.setProperty("padding", "4px 40px");

            btn.addEventListener("click", arr[i][1]);

            btn.appendChild(document.createTextNode(text));

            td.appendChild(btn);

            tr.appendChild(td);
          }

          tbl.appendChild(tr);

          return tbl;
        },
        tree_view_tasks: function(container, task_ws, offset_step, cmp)
        {
          function append_nodes(tree_node)
          {
            for ( var i = tree_node.first; i; i = i.next)
            {
              if (i.parent.id == 0)
                i.offset = 0;
              else
                i.offset = tree_node.offset + offset_step;

              container.appendChild(new_tv_node(i));

              if (i.first)
                append_nodes(i);
            }
          }

          function new_tv_node(tree_node)
          {
            var s;
            var title;

            if (tree_node.id == 0)
            {
              s = "p";
              title = "+[ADD]";
            }
            else
            {
              switch (tree_node.type)
              {
                case node_type.project:
                  s = "p";
                  break;
                case node_type.task:
                  s = "t";
                  break;
                default:
                  s = "p";
                  break;
              }
              title = tree_node.title + " (" + tree_node.id + ", " + tree_node.parent_id + ")";
            }

            var task_style        = "task_" + s;
            var task_btn_style    = "task_btn_" + s;

            var table = document.createElement("table");

            table.setAttribute("border", "0");

            var tr = document.createElement("tr");

            var td = document.createElement("td");

            td.setAttribute("width", tree_node.offset ? tree_node.offset : 0 );

            td.appendChild(document.createTextNode("\xA0"));

            tr.appendChild(td);

            td = document.createElement("td");

            td.setAttribute("class", "task " + task_style);

            var a_href = document.createElement("a");

            a_href.addEventListener("click",
              function(e)
              {
                avgproject.task_ws(task_ws, tree_node);

                e.preventDefault();
              }
            );

            a_href.setAttribute("class", "task_btn " + task_btn_style);

            a_href.setAttribute("href", tree_node.id);

            a_href.appendChild(document.createTextNode(title));

            td.appendChild(a_href);

            if (tree_node.id > 0)
            {
              td.appendChild(document.createElement("br"));

              a_href = document.createElement("a");

              a_href.addEventListener("click",
                function(e)
                {
                  e.preventDefault();
                }
              );

              a_href.setAttribute("href", tree_node.id);

              a_href.setAttribute("class", "task_btn task_btn_s");

              a_href.appendChild(document.createTextNode("(new subtask)"));

              td.appendChild(a_href);
            }

            tr.appendChild(td);

            table.appendChild(tr);

            return table;
          }

          post_request().set(
            [
              [ "action", 1 ],
            ],
            function (r)
            {
              var tasks_nodes;

              eval("tasks_nodes = [\n" + r.responseText + "\n];");

              var tasks = tree_store_build_tree(tasks_nodes, cmp);

              /*
                Вообще, функция "tree_store_build_tree"  всегда  завершается  успешно,  за
                исключением случаев когда остаются элементы для которых parent_node  найти
                не удалось. Поэтому нужно будет сделать обработку этого случая когда будет
                время.
              */

              append_nodes(tasks);

              container.appendChild(new_tv_node(tasks));
            }
          );
        },
      };

      window.onload =
        function()
        {
          document.body.appendChild(avgproject.left_right(
            function(a, b)
            {
              return a.priority < b.priority;
            }
          ));
        }
      ;
    //-->
    </script>
  </head>
  <body>
    <versioninfo>
    <h1>AVG Project</h1>
  </body>
</html>

<!-- vim: set expandtab ts=2 : //-->
